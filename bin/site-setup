#!/bin/bash
# 15.12.2010
# 13.03.2014
# 02.07.2014
# 21.07.2014
# 11.12.2014 - added mailto2
# 03.04.2015 - optional DB
# v0.9.2
# 
################################################################

script_version=0.9.2

source ../lib/optparse

add_arglim 0
add_option domain -d None "Site main domain"
add_option domain_test -t None "Site test domain"
add_option user -u "" "Site user"
add_option db -b "" "DB name"
add_option db_source -j "" "DB name"
add_option db_pass -p None "DB password"
add_option engine -i None "Engine source (tgz url, tgz file or directory), default: empty"
add_option script -s "" "Setup script"
#add_option config -c "" "Configuration file"
add_option drupal_profile -r "minimal" "Drupal installation profile, default: minimal"

add_flag rewrite -r False "Purge installed site before install"
add_flag no_reinstall -o False "No purge or install site"

add_flag verbose -v False "Verbose output"
add_flag debug -m False "Debug"

add_info "Site install script v$script_version"
add_example "$0 --user username --db db_name --domain example.com --engine /path/to/engine --db_pass SDLFksdfoi90wf9 --script drupal-setup --rewrite"

parseargs $@

# include only after parse args!
source ../lib/functions
source ../site-setup.conf

if [ $# = 0 ]; then
	usage
fi

if [ -z "$DB" ] && [ "$ENGINE" != "None" ]; then
	echo "db not set"
	usage
fi

if [ "$REWRITE" = True ] && [ "$NO_REINSTALL" = True ]; then
	echo "--rewrite и --no_reinstall взаимоисключают друг друга"
	exit 1
fi

start_time=$(date +%s)

if [ "$DB_PASS" = None ]; then
	DB_PASS=$(get_password 16)
fi
#admin_pass=$(get_password 10)
isdrupal=0

color1='\e[1;37m'
color2='\e[0;37m'
NC='\e[0m' # No Color

logfile=$(mktemp -t site-setup-logXXXX)
settings_php=$(mktemp -t site-setup-settings_phpXXXX)

function exit_command {
	is_debug && echo rm "$logfile"
	rm "$logfile"
	is_debug && echo rm "$settings_php"
	rm "$settings_php"
	rm -rf "$skeldir"
	bell
	exit 1
}

trap 'exit_command' 0 1 2 3 9 15

# 1. system user
function site_setup_user {
	USER="$USER"
	homedir="$homedir"

	isnewuser=1
	if [ -d "$homedir" ]; then
		isnewuser=0
		is_verbose && echo "directory $homedir exists, don't create user."
	fi

	if [ $isnewuser = "1" ]; then
		#user_pass=$(get_password 16)
		#echo "please, enter password twice, generated password: ${color1}$user_pass${NC}"

		is_verbose && echo "useradd --create-home --shell=/bin/bash $USER"
		#adduser $USER
		useradd --create-home --shell=/bin/bash $USER

		mkdir -p $homedir/log
		mkdir -p $wwwdir
		mkdir -p $homedir/.ssh
		touch $homedir/.ssh/authorized_keys

		# TODO: depedency
		/root/bin/ssh-add-keys $USER

		# TODO: depedency
		user-setup $USER www > /dev/null
	fi
}






# 2. extract engine files
function site_setup_engine {
	USER="$USER"
	REWRITE="$REWRITE"
	sitedir="$sitedir"
	sitedir_old="$sitedir_old"
	DEBUG="$DEBUG"
	ENGINE="$ENGINE"
	DB_SOURCE="$DB_SOURCE"
	DB_PASS="$DB_PASS"
	homedir="$homedir"

	if [ "$REWRITE" = True ]; then
		if [ -d "$sitedir_old" ]; then
			is_verbose && echo rm -rf $sitedir_old
			rm -rf $sitedir_old
		fi
		
		if [ -d "$sitedir" ]; then
			if [ "$DEBUG" = True ]; then
				echo rm -rf $sitedir
				rm -rf $sitedir
				#is_verbose && echo "old site not deleted"
			else
				is_verbose && echo "move old site to $sitedir_old"
				is_verbose && echo mv $sitedir $sitedir_old
				mv $sitedir $sitedir_old
			fi
		fi
	fi

	if [ "$REWRITE" != True ] && [ "$NO_REINSTALL" != True ] && [ -d "$sitedir" ]; then
		echo "Directory $sitedir exists, do nothing."
		echo "If you need to rewrite or update site, use --rewrite or --no_reinstall options"
		exit 1
	fi

	mkdir -p $sitedir

	if [ "$ENGINE" = "None" ]; then
		# ничего не делаем
		is_verbose && echo "empty engine"
		cd $sitedir

	elif [ "$ENGINE" = "drupal" ]; then
		is_verbose && echo "drush dl drupal --drupal-project-rename=$DOMAIN"
		cd $wwwdir
		rmdir $sitedir
		drush dl drupal --drupal-project-rename=$DOMAIN
		cd $sitedir

	elif [ -f "$ENGINE" ]; then
		is_verbose && echo "extract local archive"
		cd $sitedir
		tar -xf $ENGINE

	elif [ -d "$ENGINE" ]; then
		if [ "$NO_REINSTALL" = True ] && [ -f "$sitedir/sites/default/settings.php" ]; then
			is_verbose && echo "backup old settings.php"
			cat $sitedir/sites/default/settings.php > $settings_php
		fi

		# TODO: support snormal@localhost:/home/snormal/www/snormal.viasite.ru
		is_verbose && echo rsync --one-file-system --recursive --delete "$ENGINE/" $sitedir
		rsync --one-file-system --recursive --delete "$ENGINE/" $sitedir

		if [ "$NO_REINSTALL" = True ] && [ -f "$sitedir/sites/default/settings.php" ]; then
			is_verbose && echo "restore settings_oldinstall.php"
			cp $settings_php $sitedir/sites/default/settings_oldinstall.php
		fi

		# замена доступов к БД в settings.php
		if [ "$DB_SOURCE" != "" ] && [ -f "$sitedir/sites/default/settings.php" ]; then
			is_verbose && echo "replace db access in settings.php"
			sed -i "s/'database' => '$DB_SOURCE'/'database' => '$DB'/g" $sitedir/sites/default/settings.php
			sed -i "s/'username' => '$DB_SOURCE'/'username' => '$USER'/g" $sitedir/sites/default/settings.php
			sed -i "s/'password' => '.*'/'password' => '$DB_PASS'/g" $sitedir/sites/default/settings.php
		fi

		cd $sitedir

	elif [ $(echo "$ENGINE" | grep "@") != "" ]; then
		# TODO: support snormal@localhost:/home/snormal/www/snormal.viasite.ru
		echo rsync --recursive --delete "$ENGINE/" $sitedir
		rsync --recursive --delete "$ENGINE/" $sitedir

		if [ "$NO_REINSTALL" = True ] && [ -f "$sitedir/sites/default/settings.php" ]; then
			is_verbose && echo "restore settings_oldinstall.php"
			cp $settings_php $sitedir/sites/default/settings_oldinstall.php
		fi

		# замена доступов к БД в settings.php
		if [ "$DB_SOURCE" != "" ] && [ -f "$sitedir/sites/default/settings.php" ]; then
			is_verbose && echo "replace db access in settings.php"
			sed -i "s/'database' => '$DB_SOURCE'/'database' => '$DB'/g" $sitedir/sites/default/settings.php
			sed -i "s/'username' => '$DB_SOURCE'/'username' => '$USER'/g" $sitedir/sites/default/settings.php
			sed -i "s/'password' => '.*'/'password' => '$DB_PASS'/g" $sitedir/sites/default/settings.php
		fi

		cd $sitedir

	else
		is_verbose && echo "download engine"
		wget -O /distrib/engine.tar.gz $ENGINE
		cd $sitedir
		tar -xf /distrib/engine.tar.gz
	fi

	if [ "$ENGINE" = "drupal" ]; then
		mkdir -p $homedir/drush-backups
	fi

	chown -R $USER.$USER $sitedir
	find $sitedir -type d -exec chmod 755 {} \;
	find $sitedir -type f -exec chmod 644 {} \;
}





# 3. apache config
function site_setup_apache {
	tmpldir="$tmpldir"
	sitedir="$sitedir"
	DOMAIN="$DOMAIN"
	DOMAIN_TEST="$DOMAIN_TEST"
	USER="$USER"
	apachefile="$apachefile"

	cp $tmpldir/site_apache.conf $tmpldir/site_apache.conf.tmp
	sed -i "s|{domain}|$DOMAIN|g" $tmpldir/site_apache.conf.tmp
	sed -i "s|{sitedir}|$sitedir|g" $tmpldir/site_apache.conf.tmp
	sed -i "s|{uid}|$USER|g" $tmpldir/site_apache.conf.tmp
	sed -i "s|{gid}|$USER|g" $tmpldir/site_apache.conf.tmp
	if [ "$DOMAIN_TEST" != None ]; then
		sed -i "s|{domain_test}| $DOMAIN_TEST|g" $tmpldir/site_apache.conf.tmp
	else
		sed -i "s|{domain_test}||g" $tmpldir/site_apache.conf.tmp
	fi

	mv $tmpldir/site_apache.conf.tmp $apachefile
	ln -s $apachefile /etc/apache2/sites-enabled > /dev/null 2>&1
}





# 4. nginx config
# moved to script





# 5. database
function site_setup_database {
	USER="$USER"
	DB="$DB"
	DB_PASS="$DB_PASS"
	REWRITE="$REWRITE"
	tmpldir="$tmpldir"

	if [ -z "$DB" ]; then
		echo "skip database creation"
		return 0
	fi

	if [ "$REWRITE" = True ]; then
		# если уже есть, бекапим
		testdb=$(mysql -Brs --execute="SHOW DATABASES LIKE '$DB'")
		if [ "$testdb" = "$DB" ]; then
			if [ "$DEBUG" = True ]; then
				is_verbose && echo "not backup old database"
			else
				is_verbose && echo backup and drop database $DB...
				/root/bin/dbdump $DB > /dev/null 2>&1
			fi
			is_verbose && echo "DROP DATABASE $DB;" | mysql
			#echo "CREATE DATABASE $DB;" | mysql
		fi
	fi

	cp $tmpldir/mysql.sql $tmpldir/mysql.sql.tmp
	sed -i "s|{db}|$DB|g" $tmpldir/mysql.sql.tmp
	sed -i "s|{user}|$USER|g" $tmpldir/mysql.sql.tmp
	sed -i "s|{db_pass}|$DB_PASS|g" $tmpldir/mysql.sql.tmp
	is_verbose && cat $tmpldir/mysql.sql.tmp
	mysql < $tmpldir/mysql.sql.tmp
	rm $tmpldir/mysql.sql.tmp

	if [ "$DB_SOURCE" != "" ]; then
		# TODO: копируем базу
		mysqldump $DB_SOURCE | mysql $DB
	fi
}






# 6. domain config
# moved to script





# 7. setup script
function site_setup_script {
	SCRIPT="$SCRIPT"
	DOMAIN="$DOMAIN"
	sitedir="$sitedir"
	USER="$USER"
	DB="$DB"
	DB_PASS="$DB_PASS"
	DRUPAL_PROFILE="$DRUPAL_PROFILE"
	logfile="$logfile"
	DEBUG="$DEBUG"
	VERBOSE="$VERBOSE"

	if [ "$SCRIPT" != "" ]; then
		is_verbose && echo start setup script
		if [ "$SCRIPT" = "drupal" ]; then
			SCRIPT=/usr/local/bin/drupal-setup
		fi

		if [ ! -f "$SCRIPT" ]; then
			is_verbose && echo "$SCRIPT not found! exit"
			exit 1
		fi

		# файлы, доступные только под юзером viasite
		mkdir -p $skeldir/sites/all/modules
		cp -r /usr/local/drupal/config/ $skeldir
		cp -r /usr/local/drupal/patches/ $skeldir
		cp -r /usr/local/drupal/libraries/ $skeldir/sites/all
		cp -r /usr/local/drupal/features_viasite/ $skeldir/sites/all/modules
		cp -r /usr/local/drupal/modules/ $skeldir/sites/all/modules
		cp -r /usr/local/drupal/themes/ $skeldir/sites/all

		echo "chown -R $user:$user $sitedir"
		chown -R $USER:$USER $sitedir

		command="$SCRIPT $DOMAIN --sitedir $sitedir --user $USER --db_pass $DB_PASS --db $DB --logfile $logfile --drupal_profile $DRUPAL_PROFILE"
		if [ "$DEBUG" = True ]; then command="$command --debug"; fi
		if [ "$VERBOSE" = True ]; then command="$command --verbose"; fi
		if [ "$NO_REINSTALL" = True ]; then command="$command --no_reinstall"; fi
		is_verbose && echo su -c \"$command\" $USER
		su -c "$command" $USER

	else
		is_verbose && echo "no script defined"
	fi
}










if [ ! -d "$homedir" ]; then
	echo -e "${color1}# 1. system user${NC}"
	site_setup_user
fi

# тут юзер точно создан
chown $USER:$USER $logfile
chown $USER:$USER $settings_php

echo -e "\n${color1}# 2. extract engine files${NC}"
site_setup_engine

if [ "$NO_REINSTALL" != True ]; then
	echo -e "\n${color1}# 3. apache config${NC}"
	site_setup_apache
fi

if [ "$NO_REINSTALL" != True ]; then
	echo -e "\n${color1}# 4. nginx config${NC}"
	/root/bin/site-setup-nginx --domain "$DOMAIN" --domain_test "$DOMAIN_TEST" --sitedir "$sitedir" --nginxfile "$nginxfile"
fi

if [ "$NO_REINSTALL" != True ]; then
	reload-web > /dev/null 2>&1
fi

if [ "$NO_REINSTALL" != True ]; then
	echo -e "\n${color1}# 5. database${NC}"
	site_setup_database
fi

if [ "$NO_REINSTALL" != True ]; then
	echo -e "\n${color1}# 6. domain${NC}"
	/root/bin/site-setup-domain --domain $DOMAIN
fi

echo -e "\n${color1}# 7. setup script${NC}"
site_setup_script













if [ "$NO_REINSTALL" != True ]; then
	if [ "$VERBOSE" = True ]; then
		echo ""
		echo "##################################################"
		echo ""
		echo "for uninstall:"
		echo "rm $nginxfile"
		echo "rm $nginxfileen"
		echo "rm $apachefile"
		echo "rm $apachefileen"
		echo "reload-web"
		echo "rm -rf $sitedir"
		if [ -n "$DB" ]; then
			echo "mysql --execute=\"DROP DATABASE $DB\""
		fi
		if [ $(ls $wwwdir | wc -l) = "1" ]; then
			echo deluser $USER
			echo rm -rf $homedir
		fi
		echo ""
		echo "##################################################"
		echo ""
	fi

	#echo created user $USER with password $user_pass
	echo "domain: $DOMAIN" >> $logfile
	echo "site root: $sitedir" >> $logfile
	echo "mysql database: $DB" >> $logfile
	echo "mysql password: $DB_PASS" >> $logfile

	if [ "$SCRIPT" != "drupal" ]; then
		echo "for cron exec: cd $sitedir && drs cron-add"
	fi

	if [ "$DEBUG" != True ]; then
		body="[site-setup] $DOMAIN passwords"
		mail -s "$body" $mailto < $logfile
		echo email sent to $mailto

		mail -s "$body" $mailto2 < $logfile
		echo email sent to $mailto2
	fi
	echo ""

	cat $logfile
fi

end_time=$(date +%s)
runtime=$((end_time-start_time))
echo finished at $runtime seconds
